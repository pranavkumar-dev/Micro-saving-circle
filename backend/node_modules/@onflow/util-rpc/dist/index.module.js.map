{"version":3,"file":"index.module.js","sources":["../src/rpc-error.ts","../src/rpc-client.ts"],"sourcesContent":["export enum RpcErrorCode {\n  INVALID_REQUEST = -32600,\n  METHOD_NOT_FOUND = -32601,\n  INVALID_PARAMS = -32602,\n  INTERNAL_ERROR = -32603,\n  PARSE_ERROR = -32700,\n}\n\nexport class RpcError extends Error {\n  constructor(\n    public code: RpcErrorCode,\n    public message: string,\n    public data?: any\n  ) {\n    super(message)\n  }\n}\n","import {RpcMessage, RpcNotificationMessage, RpcRequestMessage} from \"./messages\"\nimport {RpcError, RpcErrorCode} from \"./rpc-error\"\n\nexport type RpcRequest<P, R> = {\n  type: \"request\"\n  params: P\n  result: R\n}\n\nexport type RpcNotification<P> = {\n  type: \"notification\"\n  params: P\n}\n\nenum ReservedRpcMethods {\n  HELLO = \"rpc_hello\",\n}\n\ntype RequestHandler<T = any> = (params: T) => any\ntype NotificationHandler<T = any> = (params: T) => void\n\ntype PeerInfo = {\n  requests: string[]\n  notifications: string[]\n}\n\nexport class RpcClient<\n  PeerRequests extends Record<string, RpcRequest<any, any>>,\n  PeerNotifications extends Record<string, RpcNotification<any>>,\n> {\n  private id = 0\n\n  private setSend: (send: (msg: RpcMessage) => void) => void = () => {}\n  private _send: Promise<(msg: RpcMessage) => void> = new Promise(resolve => {\n    this.setSend = resolve\n  })\n\n  private resolvePeerInfo!: (info: PeerInfo) => void\n  private rejectPeerInfo!: (error: Error) => void\n  private peerInfo: Promise<PeerInfo> = new Promise((resolve, reject) => {\n    this.resolvePeerInfo = resolve\n    this.rejectPeerInfo = reject\n  })\n\n  private enabledNotifications: string[] = []\n  private requestHandlers: Record<string, RequestHandler> = {} as any\n  private subscriptions: Record<string, Set<NotificationHandler>> = {} as any\n  private messageListeners: ((msg: any) => void)[] = []\n\n  constructor({notifications}: {notifications?: string[]}) {\n    this.enabledNotifications = notifications || []\n    this.on(ReservedRpcMethods.HELLO, (info: PeerInfo) => {\n      this.resolvePeerInfo(info)\n      return this.ownInfo()\n    })\n  }\n\n  connect({send}: {send: (msg: RpcMessage) => void}) {\n    this.setSend(send)\n    this.requestWithoutConnection(ReservedRpcMethods.HELLO, this.ownInfo())\n      .then(info => {\n        this.resolvePeerInfo(info)\n      })\n      .catch(this.rejectPeerInfo)\n  }\n\n  private ownInfo(): PeerInfo {\n    return {\n      requests: Object.keys(this.requestHandlers),\n      notifications: this.enabledNotifications,\n    }\n  }\n\n  private async send(msg: RpcMessage) {\n    return (await this._send)(msg)\n  }\n\n  receive(msg: RpcMessage) {\n    if (msg?.jsonrpc !== \"2.0\") {\n      return\n    }\n\n    if (\"method\" in msg) {\n      if (\"id\" in msg) {\n        this.handleRequest(msg)\n      } else {\n        this.handleNotification(msg)\n      }\n    }\n\n    this.messageListeners.forEach(listener => listener(msg))\n  }\n\n  private async handleRequest(msg: RpcRequestMessage) {\n    const handler = this.requestHandlers[msg.method]\n    if (handler) {\n      try {\n        const result = await handler(msg.params)\n        this.send({\n          jsonrpc: \"2.0\",\n          id: msg.id,\n          result,\n        })\n      } catch (error: any) {\n        if (error instanceof RpcError) {\n          this.send({\n            jsonrpc: \"2.0\",\n            id: msg.id,\n            error: {\n              code: error.code,\n              message: error.message,\n              data: error.data,\n            },\n          })\n        } else {\n          this.send({\n            jsonrpc: \"2.0\",\n            id: msg.id,\n            error: {\n              code: RpcErrorCode.INTERNAL_ERROR,\n              message: error?.message,\n            },\n          })\n        }\n      }\n    } else {\n      this.send({\n        jsonrpc: \"2.0\",\n        id: msg.id,\n        error: {\n          code: RpcErrorCode.METHOD_NOT_FOUND,\n          message: `Method not found: ${msg.method}`,\n        },\n      })\n    }\n  }\n\n  private handleNotification(msg: RpcNotificationMessage) {\n    if (this.subscriptions[msg.method]) {\n      this.subscriptions[msg.method].forEach(handler => handler(msg.params))\n    }\n  }\n\n  private onMessage(listener: (msg: any) => void) {\n    this.messageListeners.push(listener)\n    return () => {\n      this.messageListeners = this.messageListeners.filter(l => l !== listener)\n    }\n  }\n\n  async notify<R extends keyof PeerNotifications & string>(\n    method: R,\n    params: PeerNotifications[R][\"params\"]\n  ) {\n    await this.onceConnected()\n\n    this.send({\n      jsonrpc: \"2.0\",\n      method,\n      params,\n    })\n  }\n\n  async request<R extends keyof PeerRequests & string>(\n    method: R,\n    params: PeerRequests[R][\"params\"]\n  ): Promise<PeerRequests[R][\"result\"]> {\n    await this.onceConnected()\n    return this.requestWithoutConnection(method, params)\n  }\n\n  private async requestWithoutConnection<R extends keyof PeerRequests & string>(\n    method: R,\n    params: PeerRequests[R][\"params\"]\n  ): Promise<PeerRequests[R][\"result\"]> {\n    const id = this.id++\n\n    let unsub = () => {}\n    const result = new Promise<PeerRequests[R][\"result\"]>((resolve, reject) => {\n      unsub = this.onMessage(msg => {\n        if (msg.id === id && (\"result\" in msg || \"error\" in msg)) {\n          if (msg.error) {\n            const rpcError = new RpcError(\n              msg.error.code,\n              msg.error.message,\n              msg.error.data\n            )\n            reject(rpcError)\n          }\n          resolve(msg.result)\n        }\n      })\n    }).finally(unsub)\n\n    this.send({\n      jsonrpc: \"2.0\",\n      method,\n      params,\n      id,\n    })\n\n    return result\n  }\n\n  on(method: string, handler: RequestHandler) {\n    this.requestHandlers[method] = handler\n  }\n\n  subscribe<R extends string>(method: R, handler: RequestHandler<any>) {\n    this.subscriptions[method] = this.subscriptions[method] || new Set()\n    this.subscriptions[method].add(handler)\n  }\n\n  unsubscribe<R extends string>(method: R, handler: RequestHandler<any>) {\n    this.subscriptions[method]?.delete(handler)\n  }\n\n  async onceConnected() {\n    return this.peerInfo.then(() => {})\n  }\n\n  async getAvailableRequests() {\n    return this.peerInfo.then(info => info.requests)\n  }\n\n  async getAvailableNotifications() {\n    return this.peerInfo.then(info => info.notifications)\n  }\n}\n"],"names":["RpcErrorCode","RpcError","Error","constructor","code","message","data","ReservedRpcMethods","RpcClient","id","setSend","_send","Promise","resolve","peerInfo","reject","resolvePeerInfo","rejectPeerInfo","enabledNotifications","requestHandlers","subscriptions","messageListeners","_ref","notifications","on","HELLO","info","ownInfo","connect","_ref2","send","requestWithoutConnection","then","catch","requests","Object","keys","msg","receive","jsonrpc","handleRequest","handleNotification","forEach","listener","handler","method","result","params","error","INTERNAL_ERROR","METHOD_NOT_FOUND","onMessage","push","filter","l","notify","onceConnected","request","unsub","rpcError","finally","subscribe","Set","add","unsubscribe","delete","getAvailableRequests","getAvailableNotifications"],"mappings":"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"}